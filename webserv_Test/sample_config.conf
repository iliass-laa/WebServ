# Sample Webserv Configuration File
# Based on NGINX configuration format

# Server 1 - Main web server on port 8080
server {
    listen 8080;
    server_name localhost;
    
    # Root directory for static files
    root /var/www/html;
    
    # Default index files
    index index.html index.htm;
    
    # Maximum client body size (10 MB)
    client_max_body_size 10M;
    
    # Custom error pages
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    # Root location
    location / {
        # Allow GET, POST, DELETE
        limit_except GET POST DELETE {
            deny all;
        }
        
        # Try files in order
        try_files $uri $uri/ =404;
    }
    
    # Static files location
    location /static {
        root /var/www;
        autoindex on;  # Enable directory listing
    }
    
    # Upload location
    location /upload {
        limit_except POST DELETE {
            deny all;
        }
        upload_store /var/www/uploads;
        client_max_body_size 50M;  # Allow larger uploads here
    }
    
    # PHP CGI handling
    location ~ \.php$ {
        root /var/www/cgi-bin;
        cgi_pass /usr/bin/php-cgi;
        cgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        cgi_param QUERY_STRING $query_string;
    }
    
    # Python CGI handling
    location ~ \.py$ {
        root /var/www/cgi-bin;
        cgi_pass /usr/bin/python3;
    }
    
    # API endpoint with POST only
    location /api {
        limit_except POST {
            deny all;
        }
    }
    
    # Redirect old URLs
    location /old-page {
        return 301 /new-page.html;
    }
    
    # Protected area - no directory listing
    location /private {
        root /var/www;
        autoindex off;
    }
}

# Server 2 - Secondary server on port 8081
server {
    listen 8081;
    server_name localhost;
    
    root /var/www/site2;
    index index.html;
    
    client_max_body_size 5M;
    
    location / {
        limit_except GET {
            deny all;
        }
    }
}

# Server 3 - CGI testing server on port 8082
server {
    listen 8082;
    server_name localhost;
    
    root /var/www/cgi-bin;
    
    # All PHP files
    location ~ \.php$ {
        cgi_pass /usr/bin/php-cgi;
    }
    
    # All Python files
    location ~ \.py$ {
        cgi_pass /usr/bin/python3;
    }
    
    # Perl CGI
    location ~ \.pl$ {
        cgi_pass /usr/bin/perl;
    }
}

---

# Alternative Simpler Configuration for Basic Testing

server {
    listen 8080;
    root /var/www/html;
    index index.html;
    
    # Allow all methods
    location / {
    }
    
    # CGI support
    location ~ \.php$ {
        cgi_pass /usr/bin/php-cgi;
    }
}

---

# Configuration Notes and Requirements

## Required Directives

Based on the subject requirements, your configuration must support:

1. **listen**: Specify host:port pairs
   ```
   listen 127.0.0.1:8080;
   listen 8080;  # All interfaces
   listen 0.0.0.0:8080;
   ```

2. **server_name**: Server identification (for virtual hosts)
   ```
   server_name localhost;
   server_name example.com www.example.com;
   ```

3. **root**: Document root directory
   ```
   root /var/www/html;
   ```

4. **index**: Default files when directory is requested
   ```
   index index.html index.htm default.html;
   ```

5. **error_page**: Custom error pages
   ```
   error_page 404 /custom_404.html;
   error_page 500 502 503 504 /50x.html;
   ```

6. **client_max_body_size**: Maximum request body size
   ```
   client_max_body_size 10M;
   client_max_body_size 1024;  # In bytes if no unit
   ```

7. **limit_except**: Restrict HTTP methods
   ```
   limit_except GET POST {
       deny all;
   }
   ```

8. **return**: HTTP redirects
   ```
   return 301 /new-location;
   return 302 https://example.com;
   ```

9. **autoindex**: Directory listing on/off
   ```
   autoindex on;   # Enable directory listing
   autoindex off;  # Disable (default)
   ```

10. **upload_store**: File upload destination
    ```
    upload_store /var/www/uploads;
    ```

11. **cgi_pass**: CGI interpreter path
    ```
    cgi_pass /usr/bin/php-cgi;
    cgi_pass /usr/bin/python3;
    ```

## Location Block Rules

Locations define behavior for specific URI patterns:

```
location / {
    # Exact match for root
}

location /api {
    # Prefix match for /api*
}

location ~ \.php$ {
    # Regex match for .php extension
    # ~ means case-sensitive regex
    # ~* would be case-insensitive
}

location /uploads {
    # Handle file uploads
}
```

## CGI Configuration

For CGI to work properly, you need:

```
location ~ \.php$ {
    root /var/www/cgi-bin;           # Where scripts are located
    cgi_pass /usr/bin/php-cgi;        # Interpreter path
    
    # Optional: Set CGI parameters
    cgi_param SCRIPT_FILENAME $document_root$uri;
    cgi_param QUERY_STRING $query_string;
}
```

## Multiple Server Blocks

You can define multiple servers for:
- Different ports
- Different content
- Virtual hosting

```
server {
    listen 8080;
    root /var/www/site1;
}

server {
    listen 8081;
    root /var/www/site2;
}
```

## Testing Your Configuration

1. **Syntax check** (if you implement it):
   ```bash
   ./webserv -t config.conf
   ```

2. **Start with configuration**:
   ```bash
   ./webserv config.conf
   ```

3. **Test each feature**:
   ```bash
   # Test basic serving
   curl http://localhost:8080/
   
   # Test different port
   curl http://localhost:8081/
   
   # Test CGI
   curl http://localhost:8080/test.php
   
   # Test upload
   curl -X POST -F "file=@test.txt" http://localhost:8080/upload
   
   # Test redirect
   curl -L http://localhost:8080/old-page
   
   # Test method restriction
   curl -X DELETE http://localhost:8080/  # Should fail if restricted
   ```

## Common Configuration Errors

1. **Port already in use**: Choose unused ports or stop conflicting services
2. **Invalid paths**: Ensure root directories exist
3. **CGI interpreter not found**: Install PHP-CGI, Python, etc.
4. **Permission denied**: Check file/directory permissions
5. **Syntax errors**: Validate your configuration parser

## Minimal Working Configuration

```
server {
    listen 8080;
    root /var/www/html;
    
    location / {
    }
}
```

This is the absolute minimum needed to serve static files.
